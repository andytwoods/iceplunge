{% load i18n %}
<form id="plunge-form"
      hx-post="{% url 'plunges:create' %}"
      hx-target="#log-plunge-box-body"
      hx-swap="innerHTML swap:100ms">
  {% csrf_token %}

  {# ── Setting ─────────────────────────────────────────────────────────── #}
  <div class="field">
    <label class="label">{% translate "Setting" %}</label>
    {% if form.context.errors %}<p class="help is-danger mb-1">{{ form.context.errors.0 }}</p>{% endif %}
    <div class="plunge-radio-group">
      {% with cur=form.context.value %}
        {% for val, lbl in form.context.field.choices %}
          <input type="radio" name="context" id="ctx_{{ val }}" value="{{ val }}"
                 {% if val == cur %}checked{% endif %}>
          <label for="ctx_{{ val }}"><span class="radio-main">{{ lbl }}</span></label>
        {% endfor %}
      {% endwith %}
    </div>
  </div>

  {# ── Duration + Depth ─────────────────────────────────────────────────── #}
  <div class="columns is-mobile mb-0">
    <div class="column">
      <div class="field">
        <label class="label" for="{{ form.duration_minutes.id_for_label }}">{% translate "Duration (min)" %}</label>
        {% if form.duration_minutes.errors %}<p class="help is-danger">{{ form.duration_minutes.errors.0 }}</p>{% endif %}
        <div class="control">
          <input class="input{% if form.duration_minutes.errors %} is-danger{% endif %}"
                 type="number" min="1" max="120"
                 name="duration_minutes"
                 id="{{ form.duration_minutes.id_for_label }}"
                 value="{{ form.duration_minutes.value|default:'' }}">
        </div>
      </div>
    </div>
    <div class="column">
      <div class="field">
        <label class="label">{% translate "Depth" %}</label>
        {% if form.immersion_depth.errors %}<p class="help is-danger mb-1">{{ form.immersion_depth.errors.0 }}</p>{% endif %}
        <div class="plunge-radio-group">
          {% with cur=form.immersion_depth.value %}
            {% for val, lbl in form.immersion_depth.field.choices %}
              <input type="radio" name="immersion_depth" id="depth_{{ val }}" value="{{ val }}"
                     {% if val == cur %}checked{% endif %}>
              <label for="depth_{{ val }}"><span class="radio-main">{{ lbl }}</span></label>
            {% endfor %}
          {% endwith %}
        </div>
      </div>
    </div>
  </div>

  {# ── How hard was it to persevere? ───────────────────────────────────── #}
  <div class="field">
    <label class="label">{% translate "How hard was it to persevere?" %}</label>
    <p class="is-size-7 has-text-grey mb-2">{% translate "Rate how much mental effort it took to stay in." %}</p>
    {% if form.perceived_intensity.errors %}<p class="help is-danger mb-1">{{ form.perceived_intensity.errors.0 }}</p>{% endif %}
    <div class="plunge-radio-group is-intensity">
      {% with cur=form.perceived_intensity.value|stringformat:"s" %}
        {% for val, lbl, desc in intensity_choices %}
          <input type="radio" name="perceived_intensity" id="intensity_{{ val }}" value="{{ val }}"
                 {% if val|stringformat:"s" == cur %}checked{% endif %}>
          <label for="intensity_{{ val }}">
            <span class="radio-main">{{ val }}</span>
            <span class="radio-sub">{{ lbl }}</span>
            <span class="radio-sub" style="font-size:.65rem;">{{ desc }}</span>
          </label>
        {% endfor %}
      {% endwith %}
    </div>
  </div>

  {# ── Temperature ──────────────────────────────────────────────────────── #}
  <div class="field">
    <label class="label" for="{{ form.water_temp_celsius.id_for_label }}">{% translate "Water temperature (°C)" %} <span class="has-text-weight-normal has-text-grey is-size-7">({% translate "optional" %})</span></label>
    {% if form.water_temp_celsius.errors %}<p class="help is-danger">{{ form.water_temp_celsius.errors.0 }}</p>{% endif %}
    <div class="field has-addons mb-0">
      <div class="control is-expanded">
        <input class="input{% if form.water_temp_celsius.errors %} is-danger{% endif %}"
               type="number" step="0.1" min="-2" max="40"
               name="water_temp_celsius"
               id="{{ form.water_temp_celsius.id_for_label }}"
               placeholder="{% translate 'e.g. 12.5' %}"
               value="{{ form.water_temp_celsius.value|default:'' }}">
      </div>
      <div class="control">
        <label class="button is-static">°C</label>
      </div>
    </div>
    <label class="checkbox mt-1 is-size-7">
      <input type="checkbox" name="temp_measured"
             {% if form.temp_measured.value %}checked{% endif %}>
      {% translate "I measured this (not estimated)" %}
    </label>
  </div>

  {# ── Duck your head? ──────────────────────────────────────────────────── #}
  <div class="field">
    <label class="label">{% translate "Duck your head?" %} <span class="has-text-weight-normal has-text-grey is-size-7">({% translate "optional" %})</span></label>
    {% if form.head_submerged.errors %}<p class="help is-danger mb-1">{{ form.head_submerged.errors.0 }}</p>{% endif %}
    <div class="plunge-radio-group">
      {% with cur=form.head_submerged.value|stringformat:"s" %}
        <input type="radio" name="head_submerged" id="hs_yes" value="True"
               {% if cur == "True" %}checked{% endif %}>
        <label for="hs_yes"><span class="radio-main">{% translate "Yes" %}</span></label>
        <input type="radio" name="head_submerged" id="hs_no" value="False"
               {% if cur == "False" %}checked{% endif %}>
        <label for="hs_no"><span class="radio-main">{% translate "No" %}</span></label>
      {% endwith %}
    </div>
  </div>

  {# ── Hot treatment before? ────────────────────────────────────────────── #}
  <div class="field">
    <label class="label">{% translate "Hot treatment first?" %} <span class="has-text-weight-normal has-text-grey is-size-7">({% translate "optional" %})</span></label>
    {% if form.pre_hot_treatment.errors %}<p class="help is-danger mb-1">{{ form.pre_hot_treatment.errors.0 }}</p>{% endif %}
    <div class="columns is-mobile mb-0">
      <div class="column">
        <div class="plunge-radio-group">
          {% with cur=form.pre_hot_treatment.value|default:"" %}
            {% for val, lbl in form.pre_hot_treatment.field.choices %}
              <input type="radio" name="pre_hot_treatment" id="pht_{{ val }}" value="{{ val }}"
                     {% if val == cur %}checked{% endif %}
                     onchange="document.getElementById('pht-minutes-row').style.display='flex'">
              <label for="pht_{{ val }}"><span class="radio-main">{{ lbl }}</span></label>
            {% endfor %}
          {% endwith %}
        </div>
      </div>
      <div class="column is-narrow"
           id="pht-minutes-row"
           style="display:{% if form.pre_hot_treatment.value %}flex{% else %}none{% endif %};align-items:center;gap:.5rem;">
        <input class="input" type="number" min="1" max="180"
               name="pre_hot_treatment_minutes"
               id="{{ form.pre_hot_treatment_minutes.id_for_label }}"
               value="{{ form.pre_hot_treatment_minutes.value|default:'' }}"
               style="width:5rem;">
        <span class="is-size-7 has-text-grey">{% translate "min" %}</span>
      </div>
    </div>
  </div>

  {# ── Exercise? ─────────────────────────────────────────────────────────── #}
  <div class="field">
    <label class="label">{% translate "Exercise?" %} <span class="has-text-weight-normal has-text-grey is-size-7">({% translate "optional" %})</span></label>

    <p class="is-size-7 has-text-grey mb-1">{% translate "When" %}</p>
    {% if form.exercise_timing.errors %}<p class="help is-danger mb-1">{{ form.exercise_timing.errors.0 }}</p>{% endif %}
    <div class="plunge-radio-group mb-3">
      {% with cur=form.exercise_timing.value|default:"" %}
        {% for val, lbl in form.exercise_timing.field.choices %}
          <input type="radio" name="exercise_timing" id="et_{{ val }}" value="{{ val }}"
                 {% if val == cur %}checked{% endif %}
                 onchange="document.getElementById('exercise-detail-row').style.display='flex'">
          <label for="et_{{ val }}"><span class="radio-main">{{ lbl }}</span></label>
        {% endfor %}
      {% endwith %}
    </div>

    <p class="is-size-7 has-text-grey mb-1">{% translate "Type" %}</p>
    {% if form.exercise_type.errors %}<p class="help is-danger mb-1">{{ form.exercise_type.errors.0 }}</p>{% endif %}
    <div class="plunge-radio-group mb-3">
      {% with cur=form.exercise_type.value|default:"" %}
        {% for val, lbl in form.exercise_type.field.choices %}
          <input type="radio" name="exercise_type" id="ety_{{ val }}" value="{{ val }}"
                 {% if val == cur %}checked{% endif %}
                 onchange="document.getElementById('exercise-detail-row').style.display='flex'">
          <label for="ety_{{ val }}"><span class="radio-main">{{ lbl }}</span></label>
        {% endfor %}
      {% endwith %}
    </div>

    <div id="exercise-detail-row"
         style="display:{% if form.exercise_timing.value or form.exercise_type.value %}flex{% else %}none{% endif %};align-items:center;gap:.5rem;">
      <input class="input" type="number" min="1" max="600"
             name="exercise_minutes"
             id="{{ form.exercise_minutes.id_for_label }}"
             value="{{ form.exercise_minutes.value|default:'' }}"
             style="width:5rem;">
      <span class="is-size-7 has-text-grey">{% translate "min" %}</span>
    </div>
  </div>

  {# ── When ─────────────────────────────────────────────────────────────── #}
  <details class="mb-4">
    <summary class="is-size-7 has-text-grey" style="cursor:pointer;">
      {% translate "Change date / time (defaults to now)" %}
    </summary>
    <div class="field mt-2">
      <div class="control">
        <input class="input" type="datetime-local"
               name="timestamp"
               id="{{ form.timestamp.id_for_label }}"
               value="{{ form.initial.timestamp|default:'' }}">
      </div>
    </div>
  </details>

  {# ── More information ──────────────────────────────────────────────────── #}
  {% if daily_form and weekly_form %}
    <details id="more-info-details" class="mb-3">
      <summary class="is-size-7 has-text-grey" style="cursor:pointer;">
        {% translate "More information" %}
        <span class="has-text-weight-normal ml-1">({% translate "breathing, sleep, menstruation, alcohol, exercise, health" %})</span>
      </summary>
      <div class="mt-3">
        {# ── Breathing technique ──────────────────────────────────────── #}
        <div class="field mb-3">
          <label class="label is-small" for="{{ form.breathing_technique.id_for_label }}">
            {% translate "Breathing technique" %} <span class="has-text-weight-normal has-text-grey">({% translate "optional" %})</span>
          </label>
          <div class="control">
            <input class="input is-small" type="text"
                   name="breathing_technique"
                   id="{{ form.breathing_technique.id_for_label }}"
                   placeholder="{% translate 'e.g. Wim Hof, box breathing…' %}"
                   value="{{ form.breathing_technique.value|default:'' }}">
          </div>
        </div>
        {% include "covariates/partials/_more_info_fields.html" %}
        <div class="field mt-2">
          <div class="control">
            <button class="button is-light is-small" type="button"
                    onclick="clearMoreInfo(this.closest('form').querySelector('.more-info-fields'))">
              {% translate "Clear context answers" %}
            </button>
          </div>
        </div>
      </div>
    </details>
  {% endif %}

  <div class="field mt-4">
    <div class="control">
      <button class="button is-primary is-fullwidth" type="submit">
        {% translate "Log plunge" %}
      </button>
    </div>
  </div>

</form>
